{% extends "base.html" %}

{% block title %}รายละเอียดใบสมัคร - {{ application.candidate.first_name }} {{ application.candidate.last_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">หน้าแรก</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('jobs.company_applications') }}">รายการผู้สมัคร</a></li>
                    <li class="breadcrumb-item active" aria-current="page">รายละเอียดใบสมัคร</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-user-check text-primary"></i> รายละเอียดใบสมัคร</h1>
                    <p class="text-muted mb-0">ใบสมัครเลขที่ #{{ application.id }}</p>
                </div>
                <div>
                    <a href="{{ url_for('jobs.company_applications') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> กลับรายการ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ข้อมูลผู้สมัคร -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-user"></i> ข้อมูลผู้สมัคร</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ชื่อ-นามสกุล:</strong><br>
                            {{ application.candidate.first_name }} {{ application.candidate.last_name }}</p>
                            
                            <p><strong>รหัสผู้สมัคร:</strong><br>
                            <code>{{ application.candidate.candidate_id }}</code></p>
                            
                            <p><strong>อีเมล:</strong><br>
                            <a href="mailto:{{ application.candidate.email }}" class="text-decoration-none">
                                <i class="fas fa-envelope text-primary"></i> {{ application.candidate.email }}
                            </a></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>สถานะการศึกษา:</strong><br>
                            <span class="badge bg-{{ 'info' if application.candidate.status == 'กำลังศึกษา' else 'primary' }} fs-6">
                                <i class="fas fa-{{ 'book' if application.candidate.status == 'กำลังศึกษา' else 'graduation-cap' }}"></i>
                                {{ application.candidate.status }}
                            </span></p>
                            
                            <p><strong>วันที่สมัคร:</strong><br>
                            {{ application.application_date.strftime('%d/%m/%Y เวลา %H:%M น.') }}</p>
                            
                            <p><strong>ข้อมูลเพิ่มเติม:</strong><br>
                            <span class="text-muted">{{ application.candidate.additional_info or 'ไม่มี' }}</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ข้อมูลตำแหน่งงาน -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-briefcase"></i> ข้อมูลตำแหน่งงาน</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ตำแหน่ง:</strong><br>
                            {{ application.job.job_title }}</p>
                            
                            <p><strong>รหัสงาน:</strong><br>
                            <code>{{ application.job.job_id }}</code></p>
                            
                            <p><strong>ประเภทงาน:</strong><br>
                            <span class="badge bg-{{ 'success' if application.job.job_type == 'งานปกติ' else 'warning' }} fs-6">
                                <i class="fas fa-{{ 'briefcase' if application.job.job_type == 'งานปกติ' else 'graduation-cap' }}"></i>
                                {{ application.job.job_type }}
                            </span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>สถานะตำแหน่ง:</strong><br>
                            <span class="badge bg-{{ 'success' if application.job.status == 'เปิด' else 'secondary' }} fs-6">
                                {{ application.job.status }}
                            </span></p>
                            
                            <p><strong>วันสุดท้ายที่รับสมัคร:</strong><br>
                            {{ application.job.application_deadline.strftime('%d/%m/%Y') }}
                            {% if application.job.application_deadline < application.application_date.date() %}
                                <br><small class="text-danger">⚠️ สมัครหลังวันสุดท้าย</small>
                            {% endif %}</p>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <p><strong>รายละเอียดงาน:</strong></p>
                            <div class="bg-light p-3 rounded">
                                {{ application.job.job_description }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- การตรวจสอบสิทธิ์ -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-shield-alt"></i> การตรวจสอบสิทธิ์</h5>
                </div>
                <div class="card-body">
                    {% set is_eligible = true %}
                    
                    {% if application.job.job_type == 'สหกิจศึกษา' and application.candidate.status != 'กำลังศึกษา' %}
                        {% set is_eligible = false %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>ไม่มีสิทธิ์:</strong> ตำแหน่งสหกิจศึกษาต้องมีสถานะ "กำลังศึกษา"
                        </div>
                    {% elif application.job.job_type == 'งานปกติ' and application.candidate.status != 'จบแล้ว' %}
                        {% set is_eligible = false %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>ไม่มีสิทธิ์:</strong> งานปกติต้องมีสถานะ "จบแล้ว"
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>มีสิทธิ์:</strong> ผู้สมัครมีคุณสมบัติตรงตามตำแหน่งงาน
                        </div>
                    {% endif %}
                    
                    {% if application.job.application_deadline < application.application_date.date() %}
                        <div class="alert alert-warning">
                            <i class="fas fa-clock"></i>
                            <strong>หมายเหตุ:</strong> สมัครหลังจากวันสุดท้ายที่กำหนด
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ควบคุมสถานะ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-cogs"></i> จัดการใบสมัคร</h5>
                </div>
                <div class="card-body">
                    <p><strong>สถานะปัจจุบัน:</strong></p>
                    <div class="text-center mb-3">
                        <span class="badge bg-{% if application.status == 'รอพิจารณา' %}warning{% elif application.status == 'ผ่าน' %}success{% elif application.status == 'ไม่ผ่าน' %}danger{% else %}secondary{% endif %} fs-5 p-3">
                            {% if application.status == 'รอพิจารณา' %}
                                <i class="fas fa-clock"></i>
                            {% elif application.status == 'ผ่าน' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif application.status == 'ไม่ผ่าน' %}
                                <i class="fas fa-times-circle"></i>
                            {% endif %}
                            {{ application.status }}
                        </span>
                    </div>

                    <form method="POST" action="{{ url_for('jobs.update_application_status', application_id=application.id) }}">
                        <div class="mb-3">
                            <label for="status" class="form-label">เปลี่ยนสถานะ:</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">เลือกสถานะใหม่</option>
                                <option value="รอพิจารณา" {% if application.status == 'รอพิจารณา' %}selected{% endif %}>
                                    🕐 รอพิจารณา
                                </option>
                                <option value="ผ่าน" {% if application.status == 'ผ่าน' %}selected{% endif %}>
                                    ✅ ผ่านการคัดเลือก
                                </option>
                                <option value="ไม่ผ่าน" {% if application.status == 'ไม่ผ่าน' %}selected{% endif %}>
                                    ❌ ไม่ผ่านการคัดเลือก
                                </option>
                            </select>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> อัปเดตสถานะ
                            </button>
                        </div>
                    </form>

                    <hr>

                    <div class="d-grid gap-2">
                        <a href="mailto:{{ application.candidate.email }}?subject=แจ้งผลการสมัครงาน {{ application.job.job_title }}&body=เรียน คุณ{{ application.candidate.first_name }}%0A%0Aแจ้งผลการสมัครงานตำแหน่ง {{ application.job.job_title }}%0A%0Aขอแสดงความนับถือ%0A{{ current_user.company.company_name }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-envelope"></i> ส่งอีเมลถึงผู้สมัคร
                        </a>
                        
                        <a href="{{ url_for('jobs.job_detail', job_id=application.job.job_id) }}" 
                           class="btn btn-outline-info">
                            <i class="fas fa-eye"></i> ดูรายละเอียดตำแหน่งงาน
                        </a>
                    </div>
                </div>
            </div>

            <!-- ข้อมูลสถิติ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar"></i> ข้อมูลเพิ่มเติม</h6>
                </div>
                <div class="card-body">
                    <small>
                        <p><strong>ID ใบสมัคร:</strong> #{{ application.id }}</p>
                        <p><strong>วันที่สมัคร:</strong><br>
                        {{ application.application_date.strftime('%d/%m/%Y %H:%M น.') }}</p>
                        <p><strong>สถานะ:</strong><br>
                        {{ application.status }}
                        </p>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}